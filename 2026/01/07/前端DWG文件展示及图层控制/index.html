<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Wucheng">
    
    <title>
        
            前端DWG文件展示及图层控制 |
        
        戊成的BLOG
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/avatar.png">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"blog.wucheng.work","root":"/","language":"zh-CN"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"戊成的BLOG","author":"Wucheng","avatar":"http://q1.qlogo.cn/g?b=qq&nk=3241748701&s=640","logo":"http://q1.qlogo.cn/g?b=qq&nk=3241748701&s=640","favicon":"/images/avatar.png"},"menu":{"home":"/                        || fa-solid fa-home","archives":"/archives            || fa-solid fa-box-archive","tags":"/tags                  || fa-solid fa-tags","categories":"/categories      || fa-solid fa-layer-group","links":"/links                || fa-solid fa-link","about":"/about                || fa-solid fa-user"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"怀念过去，珍惜现在，着手未来。","hitokoto":false},"social_contact":{"enable":true,"links":{"github":"https://github.com/Furry-wucheng","weixin":null,"qq":"2538000780","weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"","category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":false,"level_badge":true,"custom_badge":["菜鸡"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":"ture","share":"ture","reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":false,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":false,"preload":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{"links":[{"title":"圈友们"},{"name":"Kroxitine-克罗西丁/Epors-伊普尔斯","link":"https://kroxitine.com/","description":"你知道吗，我有一把非常棒的锤子！","avatar":"http://q1.qlogo.cn/g?b=qq&nk=2657124519&s=640"},{"name":"炎忍","link":"https://imyan.ren/","description":"心之所愿，无所不成。","avatar":"https://blog.imyan.ren/media/avatar.png"},{"name":"扶摇 Skyrocketing","link":"https://fuyaorocket.ing/","description":"凡事豫则立，不豫则废","avatar":"https://fuyaorocket.ing/images/logo.png"},{"name":"Ctone","link":"https://onect.one/","description":"普普通通，勉勉强强算一名大学生（","avatar":"https://c.disquscdn.com/uploads/users/40625/5129/avatar92.jpg?1714050307"},{"title":"无法访问"},{"name":"Pi(品品)","link":"https://b.dopi.cc/","description":"这个人非常的懒，非常非常的懒","avatar":"http://q1.qlogo.cn/g?b=qq&nk=910083634&s=640"},{"name":"Gking(ZhanXiaoSong)","link":"https://www.gking.icu/","description":"自己来选择，不会后悔的道路","avatar":"https://www.gking.icu/img/avatar.png"},{"name":"Wainbaro(肖究佟)","link":"https://wainbaro.github.io/","description":"“画画使我快乐。”","avatar":"http://q1.qlogo.cn/g?b=qq&nk=1411878525&s=640"}]},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="http://q1.qlogo.cn/g?b=qq&nk=3241748701&s=640">
                </a>
            
            <a class="site-name border-box" href="/">
               戊成的BLOG
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/links">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-link"></i>
                                
                                友链
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/about">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-user"></i>
                                
                                关于
                                
                            </a>
                            
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/links">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-link"></i>
                                </span>
                            
                            友链
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/about">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-user"></i>
                                </span>
                            
                            关于
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        前端DWG文件展示及图层控制
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="http://q1.qlogo.cn/g?b=qq&nk=3241748701&s=640">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Wucheng</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2026-01-07 14:00:52</span>
            </span>

            
                <span class="meta-info-item post-update-date">
                    <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                    <span class="datetime" data-updated="Mon Jan 19 2026 15:42:40 GMT+0800">2026-01-19 15:42:40</span>
                </span>
            
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/">前端开发</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Vue/">Vue</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/TS/">TS</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h1><p>对接方表示由于 DWG 文件转换 GLB 模型文件效果不好，因为有很多不必要的信息，很容易干扰文件转换。所以我们希望能够让程序以及用户决定哪些图层能够参与GLB模型的生成。</p>
<p>所以我们就需要给用户做一个DWG文件展示的功能，并且能控制不同图层的显示和隐藏以表示选中该图层。</p>
<p>经过查找调研发现有几个库能够使用</p>
<ol>
<li>MXCAD</li>
<li>mlightcad&#x2F;cad-viewer</li>
<li>Autodesk Forge Viewer</li>
<li>Open Design Alliance SDK</li>
<li>LibreDWG</li>
</ol>
<p>第一个库是国产CAD库，但是由于不能商用故放弃。第三个是官方库，会提供api使用需上传到他的服务器并且也需要收费，第四个使用需要加入会，第五个是C语言编写的DWG解析并且第二个库是依赖于它。</p>
<h1 id="依赖安装"><a href="#依赖安装" class="headerlink" title="依赖安装"></a>依赖安装</h1><p>cad-viewer 有两个版本，一个是 vue3 组件，里面不仅能够查看图片甚至可以做到画线（但无法导出）。另一个则是 simple 版本，需要自行编写功能。</p>
<p>由于我们仅仅需要查看和图层功能，其余功能对我们并没有任何作用，故使用 simple 版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add @mlightcad/cad-simple-viewer@1.3.3 @mlightcad/data-model@1.5.0</span><br></pre></td></tr></table></figure>

<p>尽量使用example的版本确保不会错</p>
<h1 id="配置与实现"><a href="#配置与实现" class="headerlink" title="配置与实现"></a>配置与实现</h1><p>首先需要配置 vite.config.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&quot;vite&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&quot;@vitejs/plugin-vue&quot;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">import</span> &#123; viteStaticCopy &#125; <span class="keyword">from</span> <span class="string">&quot;vite-plugin-static-copy&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://vite.dev/config/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vue</span>(),</span><br><span class="line">    <span class="title function_">tailwindcss</span>(),</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 复制 @mlightcad worker 文件到构建输出目录</span></span><br><span class="line">    <span class="title function_">viteStaticCopy</span>(&#123;</span><br><span class="line">      <span class="attr">targets</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// 复制DXF解析器Worker文件</span></span><br><span class="line">          <span class="attr">src</span>: <span class="string">&quot;./node_modules/@mlightcad/data-model/dist/dxf-parser-worker.js&quot;</span>,</span><br><span class="line">          <span class="attr">dest</span>: <span class="string">&quot;assets&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// 复制CAD查看器Worker文件</span></span><br><span class="line">          <span class="attr">src</span>: <span class="string">&quot;./node_modules/@mlightcad/cad-simple-viewer/dist/*-worker.js&quot;</span>,</span><br><span class="line">          <span class="attr">dest</span>: <span class="string">&quot;assets&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以下是组件的实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div</span><br><span class="line">    class=&quot;fixed inset-0 z-50 flex items-center justify-center bg-black/70&quot;</span><br><span class="line">    @click.self=&quot;closeViewer&quot;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;div</span><br><span class="line">      class=&quot;relative w-[90vw] h-[90vh] bg-white rounded-lg shadow-2xl&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;div class=&quot;flex flex-col w-full h-full&quot;&gt;</span><br><span class="line">        &lt;!-- 关闭按钮 --&gt;</span><br><span class="line">        &lt;button</span><br><span class="line">          @click=&quot;closeViewer&quot;</span><br><span class="line">          class=&quot;absolute top-2 right-4 z-10 w-8 h-8 flex items-center justify-center bg-white/90 hover:bg-white rounded-full shadow-lg transition-colors&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;span class=&quot;text-gray-600 text-xl font-bold&quot;&gt;×&lt;/span&gt;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">        &lt;div</span><br><span class="line">          class=&quot;p-3 bg-gray-100 border-b border-gray-300 flex items-center gap-3&quot;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;span v-if=&quot;isLoadingLib&quot; class=&quot;text-sm text-blue-600&quot;</span><br><span class="line">            &gt;正在加载 CAD 引擎...&lt;/span</span><br><span class="line">          &gt;</span><br><span class="line">          &lt;span v-else-if=&quot;libLoadError&quot; class=&quot;text-sm text-red-600&quot;&gt;&#123;&#123;</span><br><span class="line">            libLoadError</span><br><span class="line">          &#125;&#125;&lt;/span&gt;</span><br><span class="line">          &lt;span v-else-if=&quot;fileName&quot; class=&quot;text-sm text-gray-700&quot;</span><br><span class="line">            &gt;当前文件: &#123;&#123; fileName &#125;&#125;&lt;/span</span><br><span class="line">          &gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class=&quot;flex flex-1 min-h-0&quot;&gt;</span><br><span class="line">          &lt;div</span><br><span class="line">            class=&quot;w-64 shrink-0 bg-white border-r border-gray-300 p-3 flex flex-col overflow-hidden gap-1&quot;</span><br><span class="line">          &gt;</span><br><span class="line">            &lt;h3 class=&quot;text-base font-semibold&quot;&gt;图层管理&lt;/h3&gt;</span><br><span class="line">            &lt;!-- 图层操作区域：包含全选等 --&gt;</span><br><span class="line">            &lt;div class=&quot;shrink-0&quot;&gt;</span><br><span class="line">              &lt;ElButton size=&quot;small&quot; @click=&quot;setAllLayersVisibility(true)&quot;&gt;</span><br><span class="line">                全部显示</span><br><span class="line">              &lt;/ElButton&gt;</span><br><span class="line">              &lt;ElButton size=&quot;small&quot; @click=&quot;setAllLayersVisibility(false)&quot;&gt;</span><br><span class="line">                全部隐藏</span><br><span class="line">              &lt;/ElButton&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;ElScrollbar</span><br><span class="line">              class=&quot;flex-1 min-h-0&quot;</span><br><span class="line">            &gt;</span><br><span class="line">              &lt;div v-if=&quot;layers.length === 0&quot; class=&quot;text-gray-500 text-sm shrink-0&quot;&gt;暂无图层信息&lt;/div&gt;</span><br><span class="line">              &lt;li</span><br><span class="line">                v-else</span><br><span class="line">                v-for=&quot;layer in layers&quot;</span><br><span class="line">                :key=&quot;layer.name&quot;</span><br><span class="line">                class=&quot;flex items-center py-1.5 gap-2&quot;</span><br><span class="line">              &gt;</span><br><span class="line">                &lt;label</span><br><span class="line">                  class=&quot;flex items-center gap-2 flex-1 min-w-0 cursor-pointer&quot;</span><br><span class="line">                &gt;</span><br><span class="line">                  &lt;input</span><br><span class="line">                    type=&quot;checkbox&quot;</span><br><span class="line">                    :checked=&quot;layer.visible&quot;</span><br><span class="line">                    @change=&quot;toggleLayer(layer)&quot;</span><br><span class="line">                    class=&quot;cursor-pointer shrink-0&quot;</span><br><span class="line">                  /&gt;</span><br><span class="line">                  &lt;span</span><br><span class="line">                    class=&quot;select-none hover:text-blue-500 transition-colors truncate&quot;</span><br><span class="line">                    @click=&quot;selectLayerName(layer.name)&quot;</span><br><span class="line">                    :title=&quot;layer.name&quot;</span><br><span class="line">                  &gt;</span><br><span class="line">                    &#123;&#123; layer.name &#125;&#125;</span><br><span class="line">                  &lt;/span&gt;</span><br><span class="line">                &lt;/label&gt;</span><br><span class="line">                &lt;span</span><br><span class="line">                  class=&quot;w-3 h-3 shrink-0 rounded-sm border border-gray-400&quot;</span><br><span class="line">                  :style=&quot;&#123; backgroundColor: getLayerColor(layer.color) &#125;&quot;</span><br><span class="line">                &gt;&lt;/span&gt;</span><br><span class="line">              &lt;/li&gt;</span><br><span class="line">            &lt;/ElScrollbar&gt;</span><br><span class="line">  </span><br><span class="line">            &lt;ElButton type=&quot;primary&quot; @click=&quot;handleConfirm&quot;&gt;确认&lt;/ElButton&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">          &lt;!-- CAD显示区域 --&gt;</span><br><span class="line">          &lt;div</span><br><span class="line">            class=&quot;flex-1 overflow-hidden&quot;</span><br><span class="line">            @mousedown.middle.stop.prevent</span><br><span class="line">            @mouseup.middle.stop.prevent</span><br><span class="line">            @auxclick.stop.prevent</span><br><span class="line">            @contextmenu.middle.stop.prevent</span><br><span class="line">          &gt;</span><br><span class="line">            &lt;canvas</span><br><span class="line">              ref=&quot;canvasRef&quot;</span><br><span class="line">              class=&quot;w-full h-full relative bg-gray-800&quot;</span><br><span class="line">            &gt;&lt;/canvas&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, onMounted, watch, nextTick &#125; from &quot;vue&quot;;</span><br><span class="line">import type &#123;</span><br><span class="line">  AcDbOpenDatabaseOptions,</span><br><span class="line">  AcDbObjectId,</span><br><span class="line">&#125; from &quot;@mlightcad/data-model&quot;;</span><br><span class="line">import &#123; ElButton, ElScrollbar &#125; from &quot;element-plus&quot;;</span><br><span class="line">import &#123; AcApDocManager &#125; from &quot;@mlightcad/cad-simple-viewer&quot;;</span><br><span class="line"></span><br><span class="line">// 定义 Props 和 Emits</span><br><span class="line">interface Props &#123;</span><br><span class="line">  file?: File | null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const props = defineProps&lt;Props&gt;();</span><br><span class="line"></span><br><span class="line">const emit = defineEmits&lt;&#123;</span><br><span class="line">  (e: &quot;layersUpdated&quot;, layerList: typeof layers.value): void;</span><br><span class="line">  (e: &quot;layer-selected&quot;, layerName: string[]): void;</span><br><span class="line">  (e: &quot;close&quot;): void;</span><br><span class="line">&#125;&gt;();</span><br><span class="line"></span><br><span class="line">// 状态定义</span><br><span class="line">const canvasRef = ref&lt;HTMLCanvasElement | null&gt;(null);</span><br><span class="line">const fileName = ref&lt;string&gt;(&quot;&quot;);</span><br><span class="line">const isViewerReady = ref(false); // 新增：标记 Viewer 是否已准备好</span><br><span class="line">const isLoadingLib = ref(false); // CAD 库加载状态</span><br><span class="line">const libLoadError = ref&lt;string | null&gt;(null); // 库加载错误信息</span><br><span class="line">// 图层信息</span><br><span class="line">const layers = ref&lt;</span><br><span class="line">  Array&lt;&#123; name: string; visible: boolean; id: AcDbObjectId; color: number &#125;&gt;</span><br><span class="line">&gt;([]);</span><br><span class="line"></span><br><span class="line">const closeViewer = () =&gt; &#123;</span><br><span class="line">  emit(&quot;close&quot;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 初始化 Viewer</span><br><span class="line">onMounted(async () =&gt; &#123;</span><br><span class="line">  await nextTick();</span><br><span class="line"></span><br><span class="line">  if (!canvasRef.value) &#123;</span><br><span class="line">    console.error(&quot;Canvas element not found during mount&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  // 保存原始标题</span><br><span class="line">  const originalTitle = document.title;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    isLoadingLib.value = true;</span><br><span class="line"></span><br><span class="line">    // 初始化 DocManager，绑定 Canvas</span><br><span class="line">    AcApDocManager.createInstance(&#123; canvas: canvasRef.value &#125;);</span><br><span class="line">    console.log(&quot;CAD viewer initialized successfully&quot;);</span><br><span class="line"></span><br><span class="line">    // 标记初始化完成</span><br><span class="line">    isViewerReady.value = true;</span><br><span class="line"></span><br><span class="line">    document.title = originalTitle;</span><br><span class="line"></span><br><span class="line">    // 如果 Props 中已有文件，初始化完成后立即加载</span><br><span class="line">    if (props.file) &#123;</span><br><span class="line">      loadDwgFile(props.file);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    isLoadingLib.value = false;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&quot;Failed to initialize CAD viewer:&quot;, error);</span><br><span class="line">    libLoadError.value = &quot;初始化 CAD 查看器失败&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 加载DWG文件</span><br><span class="line">const loadDwgFile = async (file: File) =&gt; &#123;</span><br><span class="line">  // 双重保险：如果 Viewer 没准备好，绝对不执行</span><br><span class="line">  if (!isViewerReady.value || !AcApDocManager) &#123;</span><br><span class="line">    console.warn(&quot;Viewer is not ready yet.&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  // 保存原始标题</span><br><span class="line">  const originalTitle = document.title;</span><br><span class="line"></span><br><span class="line">  fileName.value = file.name;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">    const arrayBuffer = await file.arrayBuffer();</span><br><span class="line"></span><br><span class="line">    const options: AcDbOpenDatabaseOptions = &#123;</span><br><span class="line">      minimumChunkSize: 1000,</span><br><span class="line">      readOnly: false,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    // 此时访问 instance 是安全的</span><br><span class="line">    const success = await AcApDocManager.instance.openDocument(</span><br><span class="line">      file.name,</span><br><span class="line">      arrayBuffer,</span><br><span class="line">      options</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    if (success) &#123;</span><br><span class="line">      console.log(&quot;DWG 文件加载成功&quot;);</span><br><span class="line">      fetchLayers();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      console.error(&quot;DWG 文件加载失败&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">    console.error(&quot;读取文件出错:&quot;, error);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    // 恢复原始标题</span><br><span class="line">    document.title = originalTitle;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 获取图层信息</span><br><span class="line"> */</span><br><span class="line">const fetchLayers = () =&gt; &#123;</span><br><span class="line">  if (!AcApDocManager) return;</span><br><span class="line">  const doc = AcApDocManager.instance.curDocument;</span><br><span class="line">  if (!doc) return;</span><br><span class="line"></span><br><span class="line">  const db = doc.database;</span><br><span class="line">  const layerTable = db.tables.layerTable;</span><br><span class="line">  const layerList: typeof layers.value = [];</span><br><span class="line"></span><br><span class="line">  const layerIterator = layerTable.newIterator();</span><br><span class="line">  for (const layer of layerIterator) &#123;</span><br><span class="line">    layerList.push(&#123;</span><br><span class="line">      id: layer.objectId,</span><br><span class="line">      name: layer.name,</span><br><span class="line">      visible: !layer.isOff,</span><br><span class="line">      color: layer.color.colorIndex || 7,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  layers.value = layerList;</span><br><span class="line">  emit(&quot;layersUpdated&quot;, layerList);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 监听file prop变化</span><br><span class="line">watch(</span><br><span class="line">  () =&gt; props.file,</span><br><span class="line">  (newFile) =&gt; &#123;</span><br><span class="line">    // 只有当有新文件 且 Viewer 已经准备好时才加载</span><br><span class="line">    if (newFile &amp;&amp; isViewerReady.value) &#123;</span><br><span class="line">      loadDwgFile(newFile);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 切换图层可见性</span><br><span class="line">const toggleLayer = (layerItem: (typeof layers.value)[0]) =&gt; &#123;</span><br><span class="line">  if (!AcApDocManager) return;</span><br><span class="line">  const doc = AcApDocManager.instance.curDocument;</span><br><span class="line">  if (!doc) return;</span><br><span class="line"></span><br><span class="line">  const db = doc.database;</span><br><span class="line">  const layer = db.tables.layerTable.getAt(layerItem.name);</span><br><span class="line"></span><br><span class="line">  if (layer) &#123;</span><br><span class="line">    layer.isOff = layerItem.visible;</span><br><span class="line">    layerItem.visible = !layerItem.visible; // 更新本地响应式状态</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 全部显示或全部隐藏图层</span><br><span class="line">const setAllLayersVisibility = (visible: boolean) =&gt; &#123;</span><br><span class="line">  if (!AcApDocManager) return;</span><br><span class="line">  const doc = AcApDocManager.instance.curDocument;</span><br><span class="line">  if (!doc) return;</span><br><span class="line"></span><br><span class="line">  layers.value.forEach((layer) =&gt; &#123;</span><br><span class="line">    layer.visible = visible;</span><br><span class="line">    const dbLayer = doc.database.tables.layerTable.getAt(layer.name);</span><br><span class="line">    if (dbLayer) &#123;</span><br><span class="line">      dbLayer.isOff = !visible;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 发送图层名称</span><br><span class="line">const selectLayerName = (name: string) =&gt; &#123;</span><br><span class="line">  console.log(&quot;Selected Layer:&quot;, name);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 将可见图层名字列表作为字符串返回</span><br><span class="line">const handleConfirm = () =&gt; &#123;</span><br><span class="line">  const visibleLayerNames = layers.value</span><br><span class="line">    .filter((layer) =&gt; layer.visible)</span><br><span class="line">    .map((layer) =&gt; layer.name)</span><br><span class="line">  console.log(&quot;Visible Layers:&quot;, visibleLayerNames);</span><br><span class="line">  emit(&quot;layer-selected&quot;, visibleLayerNames);</span><br><span class="line">  closeViewer();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 辅助函数：将 AutoCAD 颜色索引转换为 CSS 颜色</span><br><span class="line">const getLayerColor = (colorIndex: number) =&gt; &#123;</span><br><span class="line">  const colors: Record&lt;number, string&gt; = &#123;</span><br><span class="line">    1: &quot;red&quot;,</span><br><span class="line">    2: &quot;yellow&quot;,</span><br><span class="line">    3: &quot;green&quot;,</span><br><span class="line">    4: &quot;cyan&quot;,</span><br><span class="line">    5: &quot;blue&quot;,</span><br><span class="line">    6: &quot;magenta&quot;,</span><br><span class="line">    7: &quot;white&quot;,</span><br><span class="line">  &#125;;</span><br><span class="line">  return colors[colorIndex] || &quot;#ccc&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="后续加载优化"><a href="#后续加载优化" class="headerlink" title="后续加载优化"></a>后续加载优化</h1><p>由于DWG解析的库非常的大，会严重拖累加载速度，所以需要去做异步优化从而提升加载性能。</p>
<p>首先配置 vite.config.ts 的构建单独打包</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="comment">// 添加以下配置</span></span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">manualChunks</span>: &#123;</span><br><span class="line">          <span class="comment">// CAD 相关库单独打包，支持按需加载</span></span><br><span class="line">          <span class="string">&quot;cad-simple-viewer&quot;</span>: [<span class="string">&quot;@mlightcad/cad-simple-viewer&quot;</span>],</span><br><span class="line">          <span class="string">&quot;cad-data-model&quot;</span>: [<span class="string">&quot;@mlightcad/data-model&quot;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后再把需要用到组件的父组件改成异步导入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- 异步组件 --&gt;</span><br><span class="line">  &lt;Suspense&gt;</span><br><span class="line">    &lt;template #default&gt;</span><br><span class="line">      &lt;!-- DWG查看器弹窗 --&gt;</span><br><span class="line">      &lt;DwgViewer</span><br><span class="line">        v-if=&quot;dwgViewerLoaded&quot;</span><br><span class="line">        v-show=&quot;showDwgViewer&quot;</span><br><span class="line">        @close=&quot;showDwgViewer = false&quot;</span><br><span class="line">        :file=&quot;dwgFile&quot;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">    &lt;template #fallback&gt;</span><br><span class="line">      &lt;div class=&quot;w-full h-full flex items-center justify-center bg-gray-100&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;text-center&quot;&gt;</span><br><span class="line">          &lt;div class=&quot;text-blue-600 text-lg mb-2&quot;&gt;正在加载 CAD 查看器...&lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;text-gray-500 text-sm&quot;&gt;首次加载可能需要几秒钟&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/Suspense&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">const DwgViewer = defineAsyncComponent(</span><br><span class="line">  () =&gt; import(&quot;./components/DwgViewer.vue&quot;)</span><br><span class="line">);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>组件内部的依赖加载也更新成延迟异步加载 cad-simple-viewer 库，双重优化保障首屏加载。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注释掉直接import</span></span><br><span class="line"><span class="comment">// import &#123; AcApDocManager &#125; from &quot;@mlightcad/cad-simple-viewer&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">AcApDocManagerType</span> =</span><br><span class="line">  <span class="keyword">typeof</span> <span class="keyword">import</span>(<span class="string">&quot;@mlightcad/cad-simple-viewer&quot;</span>).<span class="property">AcApDocManager</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">AcApDocManager</span>: <span class="title class_">AcApDocManagerType</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载库</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadCadLibrary</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">AcApDocManager</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 已加载</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isLoadingLib.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">  libLoadError.<span class="property">value</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&quot;@mlightcad/cad-simple-viewer&quot;</span>);</span><br><span class="line">    <span class="title class_">AcApDocManager</span> = <span class="variable language_">module</span>.<span class="property">AcApDocManager</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CAD library loaded successfully&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Failed to load CAD library:&quot;</span>, error);</span><br><span class="line">    libLoadError.<span class="property">value</span> = <span class="string">&quot;加载 CAD 库失败，请刷新页面重试&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isLoadingLib.<span class="property">value</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">nextTick</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!canvasRef.<span class="property">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Canvas element not found during mount&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 保存原始标题</span></span><br><span class="line">  <span class="keyword">const</span> originalTitle = <span class="variable language_">document</span>.<span class="property">title</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 动态加载 CAD 库</span></span><br><span class="line">    <span class="keyword">const</span> loaded = <span class="keyword">await</span> <span class="title function_">loadCadLibrary</span>();</span><br><span class="line">    <span class="keyword">if</span> (!loaded || !<span class="title class_">AcApDocManager</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Failed to load CAD library&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 DocManager，绑定 Canvas</span></span><br><span class="line">    <span class="title class_">AcApDocManager</span>.<span class="title function_">createInstance</span>(&#123; <span class="attr">canvas</span>: canvasRef.<span class="property">value</span> &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CAD viewer initialized successfully&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标记初始化完成</span></span><br><span class="line">    isViewerReady.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = originalTitle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 Props 中已有文件，初始化完成后立即加载</span></span><br><span class="line">    <span class="keyword">if</span> (props.<span class="property">file</span>) &#123;</span><br><span class="line">      <span class="title function_">loadDwgFile</span>(props.<span class="property">file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Failed to initialize CAD viewer:&quot;</span>, error);</span><br><span class="line">    libLoadError.<span class="property">value</span> = <span class="string">&quot;初始化 CAD 查看器失败&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Vue/">Vue</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/TS/">TS</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2025/12/26/Three-js%E6%A8%A1%E5%9E%8B%E5%8A%A0%E8%BD%BD%E4%B8%8E%E6%88%AA%E5%9B%BE%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"
                                   title="Three.js模型加载与截图踩坑记录"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Three.js模型加载与截图踩坑记录</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85"><span class="nav-text">依赖安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="nav-text">配置与实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E7%BB%AD%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96"><span class="nav-text">后续加载优化</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2026
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Wucheng</a>
        
    </div>

    <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="nav-text">问题背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85"><span class="nav-text">依赖安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="nav-text">配置与实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E7%BB%AD%E5%8A%A0%E8%BD%BD%E4%BC%98%E5%8C%96"><span class="nav-text">后续加载优化</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->


<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
